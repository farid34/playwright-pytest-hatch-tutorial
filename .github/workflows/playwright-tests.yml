# Nom du workflow affich√© dans l'interface
# visible dans l'onglet "Actions" du repo
name: Playwright E2E Tests

on: # D√©finit quand le workflow se d√©clenche
  push: # Se d√©clenche quand on fait "git push" sur la branche main ou master
    branches: [ main, master ]
  pull_request: # Se d√©clenche quand quelqu'un cr√©e une "Pull request" vers main ou master (code test√© avant merge)
    branches: [ main, master ]
  workflow_dispatch: # Permet de lancer le workflow 'manuellement' depuis l'interface Github (Actions -> Run workflow -> clic)

permissions: # D√©finir les persmissions
  contents: write # Permet au workflow de lire le contenu de mon repo
  pages: write # Permet au workflow d'ecrire sur GitHub Pages (d√©ploy, publish allure report, ect)
  id-token: write # Permet au workflow de cr√©er des tikens d'authent

jobs: # D√©finit les t√¢ches √† ex√©cuter (1 ou n jobs, ex: test, build, deploy)
  test: # Nom du job
    timeout-minutes: 10 # Le job s'arr√™te automatiquement apr√®s 10 mn
    runs-on: ubuntu-latest # D√©finit la machine virtuelle utilis√©e

    steps: # Liste des √©tapes √† ex√©cuter dans l'ordre
    - name: Checkout code
      uses: actions/checkout@v4 # T√©l√©charge le code depuis Github

    - name: Setup Python
      uses: actions/setup-python@v5 # Installe python 3.12
      with:
        python-version: '3.12'
    
    - name: üì¶ Install Hatch
      run: pip install hatch # Install hatch
    
    - name: üîß Install dependencies
      run: hatch env create # Cr√©er env virtuel hatch et install toutes les d√©pendances du pyproject.toml
    
    - name: üåê Install Playwright browsers
      run: hatch run install-browsers # Installe les navigateurs Palywright
    
    - name: üß™ Run tests
      run: hatch run test # Lancement des tests playwright
    
    - name: Install Java (required for Allure)
      if: always()
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Install Allure
      if: always()
      run: |
        sudo wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
        sudo tar -zxvf allure-2.25.0.tgz -C /opt/
        sudo ln -s /opt/allure-2.25.0/bin/allure /usr/bin/allure

    - name: Generate Allure Report
      if: always()
      run: hatch run allure-generate

    # Publier sur Github pages
    - name: Deploy to GtHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./allure-report
        destination_dir: allure-report
    
    - name: Upload Allure Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: allure-report
        path: allure-report/
        retention-days: 7
  
    - name: üì§ Upload test results
      # Ex√©cute cette √©tape m√™me si les tests √©chouent
      if: always()
      uses: actions/upload-artifact@v4 # Utilise l'action pour uploader des fichiers
      with:
        name: test-results # Nom de l'artifact (fichier zip qui contiendra vos r√©sultats)
        path: test-results/ # Dossier √† uploader (screenshot, vid√©os, traces)
        retention-days: 7 # Garde les fichiers pendant 7 jours et les suppriment automatiquement